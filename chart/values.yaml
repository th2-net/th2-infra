---
# Default values for th2-core.

productRegistry:
  secret: th2-core
  # -- Image repository and credentials to create pull secrets
  name: ""
  username: ""
  password: ""

solutionRegistry:
  secret: th2-solution
  registry: ""
  username: ""
  password: ""

proprietaryRegistry:
  secret: th2-proprietary
  registry: ""
  username: ""
  password: ""

ingress:
  host: &host ""
  annotations:
    default:
      kubernetes.io/ingress.class: "nginx"
      nginx.ingress.kubernetes.io/enable-cors: "true"
      nginx.ingress.kubernetes.io/rewrite-target: /$1
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/configuration-snippet: rewrite ^/([a-z\-0-9]*)$ $scheme://$http_host/$1/ redirect;
    # -- Annotations will be added to all ingress-rules generated by th2-infra
    extra: {}

# -- Annotations will be added to all deployments, configMaps and ingresses that are created by th2-infra.
commonAnnotations: {}

prometheus:
  ## -- Create prometheus-operator resources like ServiceMonitors and Alerts
  operator:
    ## -- Set true if kube-prometheus-stack is used
    enabled: true
    serviceMonitor:
      # -- Namespace to install ServiceMonitor
      namespace: monitoring
      selector:
        release: prometheus
        app: kube-prometheus-stack

## -- Kubernetes cluster domain
clusterDomain: cluster.local

#Deprecated setting.It will be removed next release. Now host is taken from k8Url in infra-operator settings
#externalRabbitMQHost:
#  host: localhost

helmoperator:
  internal: true
  helm:
    versions: v3
  fullnameOverride: helm-operator
  nameOverrde: helm-operator
  chartsSyncInterval: 300m
  prometheus:
    enabled: enabled
    serviceMonitor:
      create: true
      namespace: monitoring

infraEditor:
  image:
    repository: ghcr.io/th2-net/th2-infra-editor
    tag: 1.0.65

infraRepo:
  image:
    repository: ghcr.io/th2-net/infra-repo
    tag: 0.7.2

infraOperator:
  prometheusConfiguration:
    enabled: true
    port: 9752
  image:
    repository: ghcr.io/th2-net/th2-infra-operator
    tag: 3.5.3-grpc-filters-1979795453
  config:
    chart:
      # external mirror
      # repository: https://th2-net.github.io
      #       repository: http://infra-repo:8080
      #       version: 0.7.2
      #       name: infra-operator-tpl
      git: https://github.com/th2-net/infra-operator-tpl.git
      ref: release-v0.8.0
      path: ./
    namespacePrefixes:
      - "th2-"
    k8sUrl: "<kubernetes-external-entrypoint>"
    rabbitMQManagement:
      #      host: "" -  host is taken from rabbitmq config
      port: "15672"
      username: "th2"
      password: "${RABBITMQ_PASS}"
      persistence: true
      schemaPermissions:
        configure: ""
        read: ".*"
        write: ".*"
  livenessProbe:
    initialDelaySeconds: 30
    timeoutSeconds: 5
    periodSeconds: 30
  resources:
    limits:
      cpu: 800m
      memory: 1200Mi
    requests:
      cpu: 200m
      memory: 500Mi
  jvm:
    javaToolOptions: "-XX:+ExitOnOutOfMemoryError -XX:+UseContainerSupport -XX:MaxRAMPercentage=85"

infraMgr:
  prometheusConfiguration:
    enabled: true
    port: 9752
  image:
    repository: ghcr.io/th2-net/th2-infra-mgr
    tag: 1.7.7-infra-1.8.0-2057987187
  git:
    secretName: infra-mgr
    sshDir: /home/service/keys
    repository: git@github.com:th2-net/th2-demo-configuration.git
    repositoryLocalCache: /home/service/repository
    httpAuthUsername: "" #should be stored in secret th2-git-access-schemas
    httpAuthPassword: "" #should be stored in secret th2-git-access-schemas
    # -- Infra manager git fetch interval in milliseconds
    gitFetchInterval: "14000"
  rabbitmq:
    vHostPrefix: th2-
    usernamePrefix: th2-user-
    secret: rabbitmq
    passwordLength: 24
  cassandra:
    keyspacePrefix: schema_
    secret: cassandra
  kubernetes:
    # -- must be not more than 5 symbols
    namespacePrefix: "th2-"
    ingress: ingress-rules
    configMaps:
      logging: logging-config-template
      rabbitmq: rabbit-mq-app-config
      rabbitmq-ext: rabbit-mq-external-app-config
      cassandra: cradle
      cassandra-ext: cradle-external
      prometheus: prometheus-app-config
    secrets:
      - th2-core
      - th2-solution
      - th2-proprietary
  livenessProbe:
    initialDelaySeconds: 30
    timeoutSeconds: 5
    periodSeconds: 30
  resources:
    limits:
      cpu: 500m
      memory: 2500Mi
    requests:
      cpu: 200m
      memory: 500Mi
  jvm:
    javaToolOptions: "-XX:+ExitOnOutOfMemoryError -XX:+UseContainerSupport -XX:MaxRAMPercentage=85"

infraGit:
  # -- If there is no ability to get access for cluster to repo with schemas namespaces configs git repo can be deployed internal in the cluster.
  # Change to "internal = true" in case you need internal git repo.
  internal: false
  nodePort: 32600
  image:
    repository: ghcr.io/th2-net/git-ssh
    tag: v0.1.0
  pvc:
    accessModes: ReadWriteMany
    storage: 5Gi
    storageClassName: local-storage
  resources:
    limits:
      cpu: 100m
      memory: 200Mi
    requests:
      cpu: 50m
      memory: 100Mi

rabbitmq:
  # -- If service not internal - ExternalName service will be created, credentials will be mapped to secrets / config maps
  # otherwise service will be deployed as a chart dependency
  internal: true
  memoryHighWatermark:
    enable: true
    type: absolute
    value: 1024MB
  #it is not required if the service internal
  #  host: ""
  fullnameOverride: rabbitmq
  extraConfiguration: |-
    default_vhost = th2
  auth:
    username: th2
    password: ""
    erlangCookie: ""
  rabbitmqExchange: th2-exchange
  replicaCount: 1
  podAntiAffinityPreset: hard
  persistence:
    enabled: true
    storageClass: local-storage
    size: 10Gi
  service:
    type: "NodePort"
    amqpNodePort: 32000
  metrics:
    enabled: true
    plugins: "rabbitmq_prometheus"
    serviceMonitor:
      enabled: true
      additionalLabels:
        release: prometheus
        app: kube-prometheus-stack
      path: /metrics
    prometheusRule:
      enabled: true
      namespace: "monitoring"
      rules:
        - alert: RabbitMqClusterNodeDown
          annotations:
            description: RabbitMQ {{ $labels.namespace }}/{{ $labels.pod}} is down
            summary: RabbitMQ Node Is Down
          expr: rabbitmq_up{service="rabbitmq"} == 0
          for: 5m
          labels:
            severity: critical
        - alert: RabbitMqClusterNotAllNodesRunning
          annotations:
            description:
              Some RabbitMQ Cluster Nodes Are Down in Service {{ $labels.namespace
              }}/{{ $labels.service}}
            summary:
              Some RabbitMQ Cluster Nodes Are Down in Service {{ $labels.namespace
              }}/{{ $labels.service}}
          expr: sum(rabbitmq_up{service="rabbitmq"}) by (service) < 1
          for: 5m
          labels:
            severity: critical
        - alert: RabbitMqDiskSpaceAlarm
          annotations:
            description:
              RabbitMQ {{ $labels.namespace }}/{{ $labels.pod}} Disk Space
              Alarm is going off.  Which means the node hit highwater mark and has cut
              off network connectivity, see RabbitMQ WebUI
            summary: RabbitMQ is Out of Disk Space
          expr: rabbitmq_node_disk_free_alarm{service="rabbitmq"} == 1
          for: 1m
          labels:
            severity: critical
        - alert: RabbitMqMemoryAlarm
          annotations:
            description:
              RabbitMQ {{ $labels.namespace }}/{{ $labels.pod}} High Memory
              Alarm is going off.  Which means the node hit highwater mark and has cut
              off network connectivity, see RabbitMQ WebUI
            summary: RabbitMQ is Out of Memory
          expr: rabbitmq_node_mem_alarm{service="rabbitmq"} == 1
          for: 1m
          labels:
            severity: critical
        - alert: RabbitMqMemoryUsageHigh
          annotations:
            description:
              RabbitMQ {{ $labels.namespace }}/{{ $labels.pod}} Memory Usage
              > 90%
            summary: RabbitMQ Node > 90% Memory Usage
          expr:
            (rabbitmq_node_mem_used{service="rabbitmq"} / rabbitmq_node_mem_limit{service="rabbitmq"})
            > .9
          for: 1m
          labels:
            severity: critical
        - alert: RabbitMqFileDescriptorsLow
          annotations:
            description:
              RabbitMQ {{ $labels.namespace }}/{{ $labels.pod}} File Descriptor
              Usage > 90%
            summary: RabbitMQ Low File Descriptor Available
          expr:
            (rabbitmq_fd_used{service="rabbitmq"} / rabbitmq_fd_total{service="rabbitmq"})
            > .9
          for: 5m
          labels:
            severity: critical
        - alert: RabbitMqDiskSpaceLow
          annotations:
            description:
              RabbitMQ {{ $labels.namespace }}/{{ $labels.pod}} will hit disk
              limit in the next hr based on last 15 mins trend.
            summary: RabbitMQ is Low on Disk Space and will Run Out in the next hour
          expr:
            predict_linear(rabbitmq_node_disk_free{service="rabbitmq"}[15m], 1 * 60
            * 60) < rabbitmq_node_disk_free_limit{service="rabbitmq"}
          for: 5m
          labels:
            severity: critical
  ingress:
    enabled: true
    hostname: *host
    path: /rabbitmq($|/.*)
    annotations:
      kubernetes.io/ingress.class: "nginx"
      nginx.ingress.kubernetes.io/rewrite-target: $1
      nginx.ingress.kubernetes.io/configuration-snippet: |
        rewrite ^/([a-z\-0-9]*)$ $scheme://$http_host/$1/ redirect;
        if ($request_uri ~ "^/rabbitmq(/.*)") {
          proxy_pass http://upstream_balancer$1;
          break;
        }
  diskFreeLimit: 10GB

cassandra:
  cradle:
    #    networkTopologyStrategy:
    #      dc1: 1
    instanceName: th2-infra
    timeout: 5000
    pageSize: 5000
    cradleMaxEventBatchSize: "1048576"
    cradleMaxMessageBatchSize: "1048576"
  # -- If service not internal - ExternalName service will be created, credentials will be mapped to secrets / config maps
  # otherwise service will be deployed as a chart dependency
  internal: true
  #it is not required if the service internal
  #  host: ""
  fullnameOverride: cassandra
  cluster:
    datacenter: dc1
  dbUser:
    user: th2
    # -- will be generated if empty
    password: ""
  keyspace: cradle
  persistence:
    enabled: false
    storageClass: local-storage
    size: 50Gi

dashboard:
  # -- Kubernetes dashboard values. If true - will be deployed as dependency
  internal: true
  image:
    repository: kubernetesui/dashboard
  protocolHttp: true
  rbac:
    create: true
    clusterRoleMetrics: true
  serviceAccount:
    create: false
    name: th2infra-kubernetes-dashboard
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: "nginx"
      nginx.ingress.kubernetes.io/rewrite-target: $1
      nginx.ingress.kubernetes.io/configuration-snippet: rewrite ^/([a-z\-0-9]*)$ $scheme://$http_host/$1/ redirect;
    paths:
      # -- dashboard UI ingess path
      # @default -- `"/dashboard($\|/.*)"`
      - /dashboard($|/.*)
    hosts: [*host]
