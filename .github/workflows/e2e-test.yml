name: e2e test with kind

on: [pull_request]

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1.1.0
        with:
          config: ./ci/kind-cluster.yaml

      - name: Install python and ansible dependencies
        run: |
          ansible-galaxy collection install community.crypto community.kubernetes
          pip install openshift

      - name: Run th2-infra deployment via Ansible
        env:
          E2E_PRIVATE_KEY: ${{ secrets.E2E_PRIVATE_KEY }}
        run: |
          ansible-playbook ./ci/e2e-via-ssh-deployment-playbook.yaml
          kubectl get pods --all-namespaces

      - name: Testing
        run: |
          cd ./ci
          go test th2_infra_test.go

      - name: Getting logs
        if: always()
        run: |
          kubectl -n service logs deployment/infra-mgr > infra-mgr.log
          kubectl -n service logs deployment/infra-operator > infra-operator.log
          kubectl -n schema-e2e-v101 logs deployment/rpt-data-provider > data-provider.log
          kubectl -n schema-e2e-v101 describe deployment/rpt-data-provider > data-provider.describe.log
          echo -e "\n[Pods]" && kubectl get pods --all-namespaces
          echo -e "\n[Services]" && kubectl get svc --all-namespaces
          echo -e "\n[Ingresses]" && kubectl describe ingress --all-namespaces
          echo -e "\n[HelmReleases]" && kubectl get hr --all-namespaces
          kubectl describe nodes

      - name: Uploading logs
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: infra-logs
          path: "*.log"
